<html>
  <head>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100dvh;
        width: 100dvh;
        overflow: hidden;
        background-color: red;
      }

      .content {
        inset: 0;
        position: absolute;
        overflow: hidden;
        background: black;
      }

      .content img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        position: absolute;
        inset: 0;

        display: none;
        transition: opacity 1s;
        opacity: 1;
      }

      .content img.visible {
        display: block;
      }

      @starting-style {
        .content img {
          opacity: 0;
        }
      }

      .crosshairs {
        background-color: gold;
        position: absolute;
        transition-property: translate width height;
        transition-timing-function: linear;
        transition-duration: 1s;

        display: none;
      }

      .crosshairs.horizontal {
        width: 100dvw;
        height: 1px;
        top: 50dvh;
      }

      .crosshairs.vertical {
        width: 1px;
        height: 100dvh;
        left: 50dvw;
      }

      .crosshairs.visible {
          display: block;
      }

      @starting-style {
          .crosshairs.vertical {
              height: 0dvh;
              translate: 0px 50dvh;
          }

          .crosshairs.horizontal {
              width: 0dvw;
              translate: 50dvw 0px;
          }
      }

      .marker {
        position: absolute;
        background-color: red;
      }

      .marker.x {
        width: 7px;
        height: 1px;
        margin-left: -3px;
      }

      .marker.y {
        width: 1px;
        height: 7px;
        margin-top: -3px;
      }

      .label-container {
        transition: height 700ms ease-in, translate 700ms ease-in;
        position: absolute;
        bottom: 10px;
        left: 10px;
        height: 150px;
        overflow: hidden;
        width: 500px;
        /* Add some tint to keep the text somewhat readable */
        background: rgba(0, 0, 0, 0.3);

        display: none;
      }

      .label-container.visible {
        display: block;
      }

      @starting-style {
          .label-container {
              height: 0px;
              translate: 0px -75px;
          }
      }

      .label-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        /* Fade the labels in and out with a gradient */
        background: linear-gradient(to bottom,
          rgba(255, 0, 0, 1) 0%,
          rgba(255, 0, 0, 0) 20%,
          rgba(255, 0, 0, 0) 80%,
          rgba(255, 0, 0, 1) 100%
        );
        pointer-events: none;
        z-index: 1;
        border-radius: 4px;
      }

      .label-list {
        display: flex;
        flex-direction: column;
        transition: transform 0.3s linear;
      }

      .earthquake-label {
        color: red;
        padding: 5px 10px;
        font-family: monospace;
        font-size: 14px;
        white-space: nowrap;
        flex-shrink: 0;
        text-transform: uppercase;
      }

    </style>
    <script type="module">
      import { animateInCrosshair, moveToCoordinates } from './crosshair.js';
      import { fetchEarthquakeData } from './data.js';
      import { addLabel, markCoordinate } from './gui.js';
      import { getMapDimensions, latLngToPixel } from './map.js';

      // Start fetching data immediately
      const dataPromise = fetchEarthquakeData();

      const domLoadedPromise = new Promise(resolve => {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', resolve);
        } else {
          resolve();
        }
      });

      const imageLoadedPromise = domLoadedPromise.then(() => {
        return new Promise(resolve => {
          const img = document.querySelector('.content img');
          if (img.complete) {
            resolve();
          } else {
            img.addEventListener('load', resolve);
          }
        });
      });

      // Wait for all resources
      Promise.all([domLoadedPromise, imageLoadedPromise, dataPromise]).then(async ([_, __, data]) => {
        // 1. Fade in map
        const mapImage = document.querySelector('.content img');
        mapImage.classList.add('visible');
        await new Promise(resolve => setTimeout(resolve, 800));

        // 2. Animate in crosshair and label container
        document.querySelector('.label-container').classList.add('visible');
        await animateInCrosshair();

        // 3. Start animation loop
        const { mapWidth, mapHeight, mapXOverflow, mapYOverflow } = getMapDimensions();

        let i = 0;
        while (true) {
          const earthquake = data.features[i % data.features.length];
          const { x, y } = latLngToPixel({
            mapWidth,
            mapHeight,
            mapXOverflow,
            mapYOverflow,
            lat: earthquake.geometry.coordinates[1],
            lng: earthquake.geometry.coordinates[0],
          });
          await moveToCoordinates(x, y);
          markCoordinate(x, y);
          addLabel(earthquake.properties.place, earthquake.properties.mag);
          i++;
        }
      });
    </script>
  </head>

  <body>
    <div class="content">
      <img src="./map_bw.webp" alt="World map" width="2058" height="2058">
      <div class="crosshairs horizontal"></div>
      <div class="crosshairs vertical"></div>
    </div>
    <div class="label-container">
      <div class="label-list"></div>
    </div>
  </body>
</html>
